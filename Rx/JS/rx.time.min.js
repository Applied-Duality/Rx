/*Copyright (c) Microsoft Open Technologies, Inc.  All rights reserved.
Microsoft Open Technologies would like to thank its contributors, a list.
of whom are at http://aspnetwebstack.codeplex.com/wikipage?title=Contributors..
Licensed under the Apache License, Version 2.0 (the "License"); you.
may not use this file except in compliance with the License. You may.
obtain a copy of the License at.

http://www.apache.org/licenses/LICENSE-2.0.

Unless required by applicable law or agreed to in writing, software.
distributed under the License is distributed on an "AS IS" BASIS,.
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or.
implied. See the License for the specific language governing permissions.
and limitations under the License..
*/
(function(e,t){var n=typeof exports=="object"&&exports&&(typeof e=="object"&&e&&e==e.global&&(window=e),exports);typeof define=="function"&&define.amd?define(["rx","exports"],function(n,r){return e.Rx=t(e,r,n),e.Rx}):typeof module=="object"&&module&&module.exports==n?module.exports=t(e,module.exports,require("./rx")):e.Rx=t(e,{},e.Rx)})(this,function(e,t,n,r){function w(e,t){return new o(function(n){return t.scheduleWithAbsolute(e,function(){n.onNext(0),n.onCompleted()})})}function E(e,t,n){var r=b(t);return new o(function(t){var i=0,s=e;return n.scheduleRecursiveWithAbsolute(s,function(e){var o;r>0&&(o=n.now(),s+=r,s<=o&&(s=o+r)),t.onNext(i++),e(s)})})}function S(e,t){var n=b(e);return new o(function(e){return t.scheduleWithRelative(n,function(){e.onNext(0),e.onCompleted()})})}function x(e,t,n){return e===t?new o(function(e){return n.schedulePeriodicWithState(0,t,function(t){return e.onNext(t),t+1})}):u(function(){return E(n.now()+e,t,n)})}function C(e,t){var n=this;return new o(function(r){var i=!1,s=new p,o=null,u=[],a=!1,f;return f=n.materialize().timestamp(t).subscribe(function(n){var f,l;n.value.kind==="E"?(u=[],u.push(n),o=n.value.exception,l=!a):(u.push({value:n.value,timestamp:n.timestamp+e}),l=!i,i=!0),l&&(o!==null?r.onError(o):(f=new h,s.disposable(f),f.disposable(t.scheduleRecursiveWithRelative(e,function(e){var n,s,f,l;if(o!==null)return;a=!0;do f=null,u.length>0&&u[0].timestamp-t.now()<=0&&(f=u.shift().value),f!==null&&f.accept(r);while(f!==null);l=!1,s=0,u.length>0?(l=!0,s=Math.max(0,u[0].timestamp-t.now())):i=!1,n=o,a=!1,n!==null?r.onError(n):l&&e(s)}))))}),new d(f,s)})}function k(e,t){var n=this;return u(function(){var r=e-t.now();return C.call(n,r,t)})}function L(e,t){return new o(function(n){function o(){s&&(s=!1,n.onNext(i)),r&&n.onCompleted()}var r,i,s;return new d(e.subscribe(function(e){s=!0,i=e},n.onError.bind(n),function(){r=!0}),t.subscribe(o,n.onError.bind(n),o))})}var i=n.Observable,s=i.prototype,o=n.Internals.AnonymousObservable,u=i.defer,a=i.empty,f=i.throwException,l=i.fromArray,c=n.Scheduler.timeout,h=n.SingleAssignmentDisposable,p=n.SerialDisposable,d=n.CompositeDisposable,v=n.RefCountDisposable,m=n.Subject,g=n.Internals.BinaryObserver,y=n.Internals.addRef,b=n.Scheduler.normalize,T=i.interval=function(e,t){return t||(t=c),x(e,e,t)},N=i.timer=function(e,t,n){var i;return n||(n=c),t!==r&&typeof t=="number"?i=t:t!==r&&typeof t=="object"&&(n=t),e instanceof Date&&i===r?w(e.getTime(),n):e instanceof Date&&i!==r?(i=t,E(e.getTime(),i,n)):i===r?S(e,n):x(e,i,n)};return s.delay=function(e,t){return t||(t=c),e instanceof Date?k.call(this,e.getTime(),t):C.call(this,e,t)},s.throttle=function(e,t){t||(t=c);var n=this;return new o(function(r){var i=new p,s=!1,o=0,u,a=null;return u=n.subscribe(function(n){var u,f;s=!0,a=n,o++,u=o,f=new h,i.disposable(f),f.disposable(t.scheduleWithRelative(e,function(){s&&o===u&&r.onNext(a),s=!1}))},function(e){i.dispose(),r.onError(e),s=!1,o++},function(){i.dispose(),s&&r.onNext(a),r.onCompleted(),s=!1,o++}),new d(u,i)})},s.windowWithTime=function(e,t,n){var i=this,s;return t===r&&(s=e),n===r&&(n=c),typeof t=="number"?s=t:typeof t=="object"&&(s=e,n=t),new o(function(t){var r,o,u=s,a=e,f=[],l,c=new p,g=0;return o=new d(c),l=new v(o),r=function(){var e,i,o,p,d;o=new h,c.disposable(o),i=!1,e=!1,a===u?(i=!0,e=!0):a<u?i=!0:e=!0,p=i?a:u,d=p-g,g=p,i&&(a+=s),e&&(u+=s),o.disposable(n.scheduleWithRelative(d,function(){var n;e&&(n=new m,f.push(n),t.onNext(y(n,l))),i&&(n=f.shift(),n.onCompleted()),r()}))},f.push(new m),t.onNext(y(f[0],l)),r(),o.add(i.subscribe(function(e){var t,n;for(t=0;t<f.length;t++)n=f[t],n.onNext(e)},function(e){var n,r;for(n=0;n<f.length;n++)r=f[n],r.onError(e);t.onError(e)},function(){var e,n;for(e=0;e<f.length;e++)n=f[e],n.onCompleted();t.onCompleted()})),l})},s.windowWithTimeOrCount=function(e,t,n){var r=this;return n||(n=c),new o(function(i){var s,o,u=0,a,f,l=new p,c=0;return o=new d(l),a=new v(o),s=function(t){var r=new h;l.disposable(r),r.disposable(n.scheduleWithRelative(e,function(){var e;if(t!==c)return;u=0,e=++c,f.onCompleted(),f=new m,i.onNext(y(f,a)),s(e)}))},f=new m,i.onNext(y(f,a)),s(0),o.add(r.subscribe(function(e){var n=0,r=!1;f.onNext(e),u++,u===t&&(r=!0,u=0,n=++c,f.onCompleted(),f=new m,i.onNext(y(f,a))),r&&s(n)},function(e){f.onError(e),i.onError(e)},function(){f.onCompleted(),i.onCompleted()})),a})},s.bufferWithTime=function(e,t,n){var i;return t===r&&(i=e),n||(n=c),typeof t=="number"?i=t:typeof t=="object"&&(i=e,n=t),this.windowWithTime(e,i,n).selectMany(function(e){return e.toArray()})},s.bufferWithTimeOrCount=function(e,t,n){return n||(n=c),this.windowWithTimeOrCount(e,t,n).selectMany(function(e){return e.toArray()})},s.timeInterval=function(e){var t=this;return e||(e=c),u(function(){var n=e.now();return t.select(function(t){var r=e.now(),i=r-n;return n=r,{value:t,interval:i}})})},s.timestamp=function(e){return e||(e=c),this.select(function(t){return{value:t,timestamp:e.now()}})},s.sample=function(e,t){return t||(t=c),typeof e=="number"?L(this,T(e,t)):L(this,e)},s.timeout=function(e,t,n){var r,i=this;return t||(t=f(new Error("Timeout"))),n||(n=c),e instanceof Date?r=function(e,t){n.scheduleWithAbsolute(e,t)}:r=function(e,t){n.scheduleWithRelative(e,t)},new o(function(n){var s,o=0,u=new h,a=new p,f=!1,l=new p;return a.disposable(u),s=function(){var i=o;l.disposable(r(e,function(){f=o===i;var e=f;e&&a.disposable(t.subscribe(n))}))},s(),u.disposable(i.subscribe(function(e){var t=!f;t&&(o++,n.onNext(e),s())},function(e){var t=!f;t&&(o++,n.onError(e))},function(){var e=!f;e&&(o++,n.onCompleted())})),new d(a,l)})},i.generateWithAbsoluteTime=function(e,t,n,r,i,s){return s||(s=c),new o(function(o){var u=!0,a=!1,f,l=e,c;return s.scheduleRecursiveWithAbsolute(s.now(),function(e){a&&o.onNext(f);try{u?u=!1:l=n(l),a=t(l),a&&(f=r(l),c=i(l))}catch(s){o.onError(s);return}a?e(c):o.onCompleted()})})},i.generateWithRelativeTime=function(e,t,n,r,i,s){return s||(s=c),new o(function(o){var u=!0,a=!1,f,l=e,c;return s.scheduleRecursiveWithRelative(0,function(e){a&&o.onNext(f);try{u?u=!1:l=n(l),a=t(l),a&&(f=r(l),c=i(l))}catch(s){o.onError(s);return}a?e(c):o.onCompleted()})})},s.delaySubscription=function(e,t){return t||(t=c),this.delayWithSelector(N(e,t),function(){return a()})},s.delayWithSelector=function(e,t){var n=this,r,i;return typeof e=="function"?i=e:(r=e,i=t),new o(function(e){var t=new d,s=!1,o=function(){s&&t.length===0&&e.onCompleted()},u=new p,a=function(){u.setDisposable(n.subscribe(function(n){var r;try{r=i(n)}catch(s){e.onError(s);return}var u=new h;t.add(u),u.setDisposable(r.subscribe(function(){e.onNext(n),t.remove(u),o()},e.onError.bind(e),function(){e.onNext(n),t.remove(u),o()}))},e.onError.bind(e),function(){s=!0,u.dispose(),o()}))};return r?u.setDisposable(r.subscribe(function(){a()},e.onError.bind(onError),function(){a()})):a(),new d(u,t)})},s.timeoutWithSelector=function(e,t,n){e||(e=observableNever()),n||(n=f(new Error("Timeout")));var r=this;return new o(function(i){var s=new p,o=new p,u=new h;s.setDisposable(u);var a=0,f=!1,l=function(e){var t=a,r=function(){return a===t},u=new h;o.setDisposable(u),u.setDisposable(e.subscribe(function(){r()&&s.setDisposable(n.subscribe(i)),u.dispose()},function(e){r()&&i.onError(e)},function(){r()&&s.setDisposable(n.subscribe(i))}))};l(e);var c=function(){var e=!f;return e&&a++,e};return u.setDisposable(r.subscribe(function(e){if(c()){i.onNext(e);var n;try{n=t(e)}catch(r){i.onError(r);return}l(n)}},function(e){c()&&i.onError(e)},function(){c()&&i.onCompleted()})),new d(s,o)})},s.throttleWithSelector=function(e){var t=this;return new o(function(n){var r,i=!1,s=new p,o=0,u=t.subscribe(function(t){var u;try{u=e(t)}catch(a){n.onError(a);return}i=!0,r=t,o++;var f=o,l=new h;s.setDisposable(l),l.setDisposable(u.subscribe(function(){i&&o===f&&n.onNext(r),i=!1,l.dispose()},n.onError.bind(n),function(){i&&o===f&&n.onNext(r),i=!1,l.dispose()}))},function(e){s.dispose(),n.onError(e),i=!1,o++},function(){s.dispose(),i&&n.onNext(r),n.onCompleted(),i=!1,o++});return new d(u,s)})},s.skipLastWithTime=function(e,t){t||(t=c);var n=this;return new o(function(r){var i=[];return n.subscribe(function(n){var s=t.now();i.push({interval:s,value:n});while(i.length>0&&s-i[0].interval>=e)r.onNext(i.shift().value)},r.onError.bind(r),function(){var n=t.now();while(i.length>0&&n-i[0].interval>=e)r.onNext(i.shift().value);r.onCompleted()})})},s.takeLastWithTime=function(e,t,n){return this.takeLastBufferWithTime(e,t).selectMany(function(e){return l(e,n)})},s.takeLastBufferWithTime=function(e,t){var n=this;return t||(t=c),new o(function(r){var i=[];return n.subscribe(function(n){var r=t.now();i.push({interval:r,value:n});while(i.length>0&&r-i[0].interval>=e)i.shift()},r.onError.bind(r),function(){var n=t.now(),s=[];while(i.length>0){var o=i.shift();n-o.interval<=e&&s.push(o.value)}r.onNext(s),r.onCompleted()})})},s.takeWithTime=function(e,t){var n=this;return t||(t=c),new o(function(r){var i=t.scheduleWithRelative(e,function(){r.onCompleted()});return new d(i,n.subscribe(r))})},s.skipWithTime=function(e,t){var n=this;return t||(t=c),new o(function(r){var i=!1,s=t.scheduleWithRelative(e,function(){i=!0}),o=n.subscribe(function(e){i&&r.onNext(e)},r.onError.bind(r),r.onCompleted.bind(r));return new d(s,o)})},s.skipUntilWithTime=function(e,t){t||(t=c);var n=this;return new o(function(r){var i=!1,s=t.scheduleWithAbsolute(e,function(){i=!0}),o=n.subscribe(function(e){i&&r.onNext(e)},r.onError.bind(r),r.onCompleted.bind(r));return new d(s,o)})},s.takeUntilWithTime=function(e,t){t||(t=c);var n=this;return new o(function(r){return new d(t.scheduleWithAbsolute(e,function(){r.onCompleted()}),n.subscribe(r))})},n});